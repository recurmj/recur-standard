# RIP-004: Non-Custodial Rebalancing

**Author:** M J (Recur Labs)  
**Status:** Final (v1.0 reference)  
**Date:** October 2025  
**Depends on:** RIP-001 (Permissioned Pull Objects), RIP-002 (Consent Registry), RIP-003 (Flow Intent)

---

## Abstract

RIP-004 defines how authorized executors fulfill a signed *FlowIntent* (RIP-003) to move value across domains without custody, without wrapping, and without unsafe bridging.  
Instead of pushing funds through intermediaries, RIP-004 performs coordinated *permissioned pulls* from the grantor’s source balance directly into the destination domain, within the boundaries of that consent.

---

## Motivation

When volatility spikes, liquidity often sits in the wrong place.  
Today, “fixing it” means custodial bridges, OTC transfers, or forced liquidation.  
RIP-004 replaces those reactions with proactive, consented rebalancing.  

The system can continuously pull value from where it is over-allocated and redirect it to where it is under-allocated *before* under-collateralization or systemic stress occur.  

---

## Core Ideas

- You do not “bridge and hold.” You **trigger a pull** from the source side directly into the destination side using the grantor’s signed permission.  
- The **executor never takes custody**; they only initiate movement under cryptographic proof.  
- **Revocation by the grantor** instantly halts all future flows.  

---

## Specification (High-Level Execution Path)

1. A valid *FlowIntent* (RIP-003) exists, signed by the grantor.  
   It specifies:  
   `(srcDomain → dstDomain, token, maxAmount, validAfter, validBefore, executor).`
2. The authorized executor calls the **CrossNetworkRebalancer** contract with that signed intent and any required domain proofs.
3. The contract verifies:
   - signature authenticity  
   - time-window validity  
   - registry state (not revoked)  
   - cumulative cap not exceeded  
4. Upon verification, the Rebalancer executes one of:
   - a direct `AuthorizationPull()` (RIP-001),  
   - a governed `FlowChannel` (RIP-005), or  
   - a domain-specific adapter (for L2s, custodial systems, or vaults).  
5. Value flows **grantor → destination** directly.  
   Executor never touches or holds funds.

### Example Interface (conceptual)

~~~
function executeRebalance(
    bytes calldata signedFlowIntent,
    bytes calldata proofSrc,
    bytes calldata proofDst
) external returns (bool success);
~~~

Each domain adapter enforces native token logic; no wrapped tokens or IOUs are created.

---

## Security and Revocation Model

- The grantor may revoke any FlowIntent hash via the Consent Registry (RIP-002) at any time.  
- Rebalancer checks registry status before every pull.  
- All accounting is cumulative (`cumulativeUsed` enforced), preventing multi-drain.  
- Optional **PolicyEnforcer** (RIP-007) modules may introduce compliance or timing constraints before execution.  
- All events (`RebalanceExecuted`, `FlowRevoked`) are emitted on-chain for full auditability.

---

## Reference Implementation

Implemented in `CrossNetworkRebalancer.sol` using:  
- `FlowIntentRegistry.sol` for state verification  
- `DomainDirectory.sol` for domain adapter mapping  
- `FlowChannelHardened.sol` for safe execution loops  

RIP-004 composes these modules into the production-ready, non-custodial rebalancing layer.

---

## Narrative Summary

RIP-004 is **automated defense**.  
Liquidity moves itself before stress hits; not after.  
By executing intent through consented pull, Recur transforms crisis response into continuous equilibrium.

---

© 2025 Recur Labs — Part of the Recur Permissioned-Pull Standard (RIP Series 001–008)
