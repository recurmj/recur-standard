# RIP-006: Universal Clock & Adaptive Routing

**Author:** M J (Recur Labs)  
**Status:** Draft  
**Version:** 0.1  
**Date:** October 2025  
**Depends on:** RIP-003 (Cross-Network Flow Intent), RIP-004 (Non-Custodial Rebalancing), RIP-005 (Flow Channels)  

---

## Abstract

RIP-006 defines **timing, ordering, and adaptive path selection** for continuous flows across multiple domains or chains.  
It introduces a **Universal Clock**, a shared notion of “epoch”, and an **Adaptive Router** that coordinates rate-based pulls across networks deterministically, ensuring all movement remains consented, auditable, and within global caps.

---

## Motivation

Once value flows continuously (RIP-005), multi-chain systems require synchronized cadence and global exposure control.  
Without shared timing or routing discipline, one side could drain ahead of schedule, break rate symmetry, or violate overall consent limits.  

RIP-006 introduces the **metronome and traffic director** for the permissioned-pull ecosystem; aligning cross-chain flows with a universal heartbeat.

---

## Specification (High-Level)

### 1. Universal Clock

- Defines discrete **epochs** (e.g. 1-second, 12-second, or 1-block abstractions) that flows account against.  
- Each Flow Channel (RIP-005) reports **consumption per epoch**.  
- Epoch boundaries create deterministic cutoffs for rate and reconciliation logic.  
- Disputes can be resolved by comparing **signed epoch state** across chains or relayers.

~~~solidity
// Simplified representation
struct Epoch {
    uint256 index;          // global epoch number
    uint256 startTime;      // start timestamp
    uint256 endTime;        // end timestamp
}
~~~

A standard epoch cadence (e.g. 12-second alignment) enables consistent multi-chain flow accounting and synchronization.

---

### 2. Adaptive Router

- Takes a **FlowIntent (RIP-003)** describing target liquidity distribution.  
- Chooses **which channels** (RIP-005) to draw from, and **on which domains**, during each epoch.  
- Moves liquidity toward the desired balance **without breaching any per-channel rule** (rate, cap, pause, or revoke).  
- Routing decisions are logged for auditability and replay.

~~~solidity
// Pseudocode sketch
function routeEpoch(Epoch memory epoch, FlowIntent memory intent) external {
    for each channel in activeChannels:
        if (!channel.revoked && !channel.paused) {
            uint256 available = channel.accruedForEpoch(epoch);
            uint256 needed = computeShare(intent, channel);
            uint256 toPull = min(available, needed);
            executePull(channel, toPull);
        }
}
~~~

The Adaptive Router ensures continuous rebalancing without ever taking custody.

---

### 3. Compliance and Safety

- Router **MUST NOT** bypass a channel’s revocation, pause, or policy.  
- Router **MUST** log all routing decisions per epoch for deterministic replay.  
- Integrates with policy enforcement (RIP-007) for regulated flows.  
- If any underlying PPO or channel is revoked, router **MUST** stop drawing from it in subsequent epochs.

---

## Reference Implementation

See `UniversalClock.sol` and `AdaptiveRouter.sol`.  
These are **utility modules**, not standalone money movers — they provide time coordination and routing logic for permissioned-pull ecosystems.

---

## Narrative Line

RIP-006 gives money a heartbeat all chains agree on.
